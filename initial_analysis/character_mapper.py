from gfx_fonts import get_tom_thumb_font

class CharacterMapper:
    """
    A class to map characters to their 8x11 dot matrix representations using GFX fonts.
    """
    
    def __init__(self, use_gfx_font=True):
        """
        Initialize the character mapper
        
        Args:
            use_gfx_font: If True, use GFX font system. If False, use legacy bitmap font.
        """
        self.use_gfx_font = use_gfx_font
        
        if use_gfx_font:
            self.gfx_font = get_tom_thumb_font()
        else:
            self._init_legacy_font()
    
    def _init_legacy_font(self):
        """Initialize the legacy font dictionary"""
        self.FONT = {
        ' ': [0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000,
            0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000],
        '!': [0b00011000, 0b00011000, 0b00011000, 0b00011000, 0b00011000,
            0b00011000, 0b00000000, 0b00011000, 0b00000000, 0b00000000, 0b00000000],
        '"': [0b01100110, 0b01100110, 0b01100110, 0b00000000, 0b00000000,
            0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000],
        '#': [0b01100110, 0b01100110, 0b11111111, 0b01100110, 0b11111111,
            0b01100110, 0b01100110, 0b00000000, 0b00000000, 0b00000000, 0b00000000],
        '$': [0b00011000, 0b01111110, 0b11000000, 0b01111100, 0b00000110,
            0b11111110, 0b00011000, 0b00000000, 0b00000000, 0b00000000, 0b00000000],
        '%': [0b11000110, 0b11001100, 0b00011000, 0b00110000, 0b01100000,
            0b11000110, 0b10000110, 0b00000000, 0b00000000, 0b00000000, 0b00000000],
        '&': [0b00111000, 0b01101100, 0b00111000, 0b01110110, 0b11011100,
            0b11001100, 0b01110110, 0b00000000, 0b00000000, 0b00000000, 0b00000000],
        "'": [0b00011000, 0b00011000, 0b00110000, 0b00000000, 0b00000000,
            0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000],
        '(': [0b00001100, 0b00011000, 0b00110000, 0b00110000, 0b00110000,
            0b00011000, 0b00001100, 0b00000000, 0b00000000, 0b00000000, 0b00000000],
        ')': [0b01100000, 0b00110000, 0b00011000, 0b00011000, 0b00011000,
            0b00110000, 0b01100000, 0b00000000, 0b00000000, 0b00000000, 0b00000000],
        '*': [0b00000000, 0b01100110, 0b00111100, 0b11111111, 0b00111100,
            0b01100110, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000],
        '+': [0b00000000, 0b00011000, 0b00011000, 0b01111110, 0b00011000,
            0b00011000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000],
        ',': [0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000,
            0b00011000, 0b00011000, 0b00110000, 0b00000000, 0b00000000, 0b00000000],
        '-': [0b00000000, 0b00000000, 0b00000000, 0b01111110, 0b00000000,
            0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000],
        '.': [0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000,
            0b00000000, 0b00011000, 0b00011000, 0b00000000, 0b00000000, 0b00000000],
        '/': [0b00000110, 0b00001100, 0b00011000, 0b00110000, 0b01100000,
            0b11000000, 0b10000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000],
        '0': [0b00111100, 0b01100110, 0b01101110, 0b01110110, 0b01100110,
            0b01100110, 0b00111100, 0b00000000, 0b00000000, 0b00000000, 0b00000000],
        '1': [0b00011000, 0b00111000, 0b00011000, 0b00011000, 0b00011000,
            0b00011000, 0b01111110, 0b00000000, 0b00000000, 0b00000000, 0b00000000],
        '2': [0b00111100, 0b01100110, 0b00000110, 0b00001100, 0b00110000,
            0b01100000, 0b01111110, 0b00000000, 0b00000000, 0b00000000, 0b00000000],
        '3': [0b00111100, 0b01100110, 0b00000110, 0b00011100, 0b00000110,
            0b01100110, 0b00111100, 0b00000000, 0b00000000, 0b00000000, 0b00000000],
        '4': [0b00001100, 0b00011100, 0b00111100, 0b01101100, 0b01111110,
            0b00001100, 0b00001100, 0b00000000, 0b00000000, 0b00000000, 0b00000000],
        '5': [0b01111110, 0b01100000, 0b01111100, 0b00000110, 0b00000110,
            0b01100110, 0b00111100, 0b00000000, 0b00000000, 0b00000000, 0b00000000],
        '6': [0b00111100, 0b01100110, 0b01100000, 0b01111100, 0b01100110,
            0b01100110, 0b00111100, 0b00000000, 0b00000000, 0b00000000, 0b00000000],
        '7': [0b01111110, 0b00000110, 0b00001100, 0b00011000, 0b00110000,
            0b00110000, 0b00110000, 0b00000000, 0b00000000, 0b00000000, 0b00000000],
        '8': [0b00111100, 0b01100110, 0b01100110, 0b00111100, 0b01100110,
            0b01100110, 0b00111100, 0b00000000, 0b00000000, 0b00000000, 0b00000000],
        '9': [0b00111100, 0b01100110, 0b01100110, 0b00111110, 0b00000110,
            0b01100110, 0b00111100, 0b00000000, 0b00000000, 0b00000000, 0b00000000],
        ':': [0b00000000, 0b00000000, 0b00011000, 0b00011000, 0b00000000,
            0b00011000, 0b00011000, 0b00000000, 0b00000000, 0b00000000, 0b00000000],
        ';': [0b00000000, 0b00000000, 0b00011000, 0b00011000, 0b00000000,
            0b00011000, 0b00011000, 0b00110000, 0b00000000, 0b00000000, 0b00000000],
        '<': [0b00001100, 0b00011000, 0b00110000, 0b01100000, 0b00110000,
            0b00011000, 0b00001100, 0b00000000, 0b00000000, 0b00000000, 0b00000000],
        '=': [0b00000000, 0b00000000, 0b01111110, 0b00000000, 0b01111110,
            0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000],
        '>': [0b01100000, 0b00110000, 0b00011000, 0b00001100, 0b00011000,
            0b00110000, 0b01100000, 0b00000000, 0b00000000, 0b00000000, 0b00000000],
        '?': [0b00111100, 0b01100110, 0b00000110, 0b00001100, 0b00011000,
            0b00000000, 0b00011000, 0b00000000, 0b00000000, 0b00000000, 0b00000000],
        '@': [0b00111100, 0b01100110, 0b01101110, 0b01101110, 0b01100000,
            0b01100010, 0b00111100, 0b00000000, 0b00000000, 0b00000000, 0b00000000],
        'A': [0b00011000, 0b00111100, 0b01100110, 0b01100110, 0b01111110,
            0b01100110, 0b01100110, 0b00000000, 0b00000000, 0b00000000, 0b00000000],
        'B': [0b01111100, 0b01100110, 0b01100110, 0b01111100, 0b01100110,
            0b01100110, 0b01111100, 0b00000000, 0b00000000, 0b00000000, 0b00000000],
        'C': [0b00111100, 0b01100110, 0b01100000, 0b01100000, 0b01100000,
            0b01100110, 0b00111100, 0b00000000, 0b00000000, 0b00000000, 0b00000000],
        'D': [0b01111000, 0b01101100, 0b01100110, 0b01100110, 0b01100110,
            0b01101100, 0b01111000, 0b00000000, 0b00000000, 0b00000000, 0b00000000],
        'E': [0b01111110, 0b01100000, 0b01100000, 0b01111100, 0b01100000,
            0b01100000, 0b01111110, 0b00000000, 0b00000000, 0b00000000, 0b00000000],
        'F': [0b01111110, 0b01100000, 0b01100000, 0b01111100, 0b01100000,
            0b01100000, 0b01100000, 0b00000000, 0b00000000, 0b00000000, 0b00000000],
        'G': [0b00111100, 0b01100110, 0b01100000, 0b01101110, 0b01100110,
            0b01100110, 0b00111100, 0b00000000, 0b00000000, 0b00000000, 0b00000000],
        'H': [0b01100110, 0b01100110, 0b01100110, 0b01111110, 0b01100110,
            0b01100110, 0b01100110, 0b00000000, 0b00000000, 0b00000000, 0b00000000],
        'I': [0b01111110, 0b00011000, 0b00011000, 0b00011000, 0b00011000,
            0b00011000, 0b01111110, 0b00000000, 0b00000000, 0b00000000, 0b00000000],
        'J': [0b00111110, 0b00000110, 0b00000110, 0b00000110, 0b01100110,
            0b01100110, 0b00111100, 0b00000000, 0b00000000, 0b00000000, 0b00000000],
        'K': [0b01100110, 0b01101100, 0b01111000, 0b01110000, 0b01111000,
            0b01101100, 0b01100110, 0b00000000, 0b00000000, 0b00000000, 0b00000000],
        'L': [0b01100000, 0b01100000, 0b01100000, 0b01100000, 0b01100000,
            0b01100000, 0b01111110, 0b00000000, 0b00000000, 0b00000000, 0b00000000],
        'M': [0b01100110, 0b01111110, 0b01111110, 0b01101010, 0b01100110,
            0b01100110, 0b01100110, 0b00000000, 0b00000000, 0b00000000, 0b00000000],
        'N': [0b01100110, 0b01110110, 0b01111110, 0b01111110, 0b01101110,
            0b01100110, 0b01100110, 0b00000000, 0b00000000, 0b00000000, 0b00000000],
        'O': [0b00111100, 0b01100110, 0b01100110, 0b01100110, 0b01100110,
            0b01100110, 0b00111100, 0b00000000, 0b00000000, 0b00000000, 0b00000000],
        'P': [0b01111100, 0b01100110, 0b01100110, 0b01111100, 0b01100000,
            0b01100000, 0b01100000, 0b00000000, 0b00000000, 0b00000000, 0b00000000],
        'Q': [0b00111100, 0b01100110, 0b01100110, 0b01100110, 0b01101010,
            0b01101100, 0b00110110, 0b00000000, 0b00000000, 0b00000000, 0b00000000],
        'R': [0b01111100, 0b01100110, 0b01100110, 0b01111100, 0b01111000,
            0b01101100, 0b01100110, 0b00000000, 0b00000000, 0b00000000, 0b00000000],
        'S': [0b00111100, 0b01100110, 0b01100000, 0b00111100, 0b00000110,
            0b01100110, 0b00111100, 0b00000000, 0b00000000, 0b00000000, 0b00000000],
        'T': [0b01111110, 0b00011000, 0b00011000, 0b00011000, 0b00011000,
            0b00011000, 0b00011000, 0b00000000, 0b00000000, 0b00000000, 0b00000000],
        'U': [0b01100110, 0b01100110, 0b01100110, 0b01100110, 0b01100110,
            0b01100110, 0b00111100, 0b00000000, 0b00000000, 0b00000000, 0b00000000],
        'V': [0b01100110, 0b01100110, 0b01100110, 0b01100110, 0b01100110,
            0b00111100, 0b00011000, 0b00000000, 0b00000000, 0b00000000, 0b00000000],
        'W': [0b01100110, 0b01100110, 0b01100110, 0b01101010, 0b01111110,
            0b01111110, 0b01100110, 0b00000000, 0b00000000, 0b00000000, 0b00000000],
        'X': [0b01100110, 0b01100110, 0b00111100, 0b00011000, 0b00111100,
            0b01100110, 0b01100110, 0b00000000, 0b00000000, 0b00000000, 0b00000000],
        'Y': [0b01100110, 0b01100110, 0b01100110, 0b00111100, 0b00011000,
            0b00011000, 0b00011000, 0b00000000, 0b00000000, 0b00000000, 0b00000000],
        'Z': [0b01111110, 0b00000110, 0b00001100, 0b00011000, 0b00110000,
            0b01100000, 0b01111110, 0b00000000, 0b00000000, 0b00000000, 0b00000000],
        '[': [0b00111100, 0b00110000, 0b00110000, 0b00110000, 0b00110000,
            0b00110000, 0b00111100, 0b00000000, 0b00000000, 0b00000000, 0b00000000],
        '\\': [0b11000000, 0b01100000, 0b00110000, 0b00011000, 0b00001100,
            0b00000110, 0b00000010, 0b00000000, 0b00000000, 0b00000000, 0b00000000],
        ']': [0b00111100, 0b00001100, 0b00001100, 0b00001100, 0b00001100,
            0b00001100, 0b00111100, 0b00000000, 0b00000000, 0b00000000, 0b00000000],
        '^': [0b00011000, 0b00111100, 0b01100110, 0b00000000, 0b00000000,
            0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000],
        '_': [0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000,
            0b00000000, 0b00000000, 0b11111111, 0b00000000, 0b00000000, 0b00000000],
        '`': [0b00110000, 0b00011000, 0b00001100, 0b00000000, 0b00000000,
            0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000],
        'a': [0b00000000, 0b00000000, 0b00111100, 0b00000110, 0b00111110,
            0b01100110, 0b00111110, 0b00000000, 0b00000000, 0b00000000, 0b00000000],
        'b': [0b01100000, 0b01100000, 0b01111100, 0b01100110, 0b01100110,
            0b01100110, 0b01111100, 0b00000000, 0b00000000, 0b00000000, 0b00000000],
        'c': [0b00000000, 0b00000000, 0b00111100, 0b01100000, 0b01100000,
            0b01100110, 0b00111100, 0b00000000, 0b00000000, 0b00000000, 0b00000000],
        'd': [0b00000110, 0b00000110, 0b00111110, 0b01100110, 0b01100110,
            0b01100110, 0b00111110, 0b00000000, 0b00000000, 0b00000000, 0b00000000],
        'e': [0b00000000, 0b00000000, 0b00111100, 0b01100110, 0b01111110,
            0b01100000, 0b00111100, 0b00000000, 0b00000000, 0b00000000, 0b00000000],
        'f': [0b00001110, 0b00011000, 0b00011000, 0b01111110, 0b00011000,
            0b00011000, 0b00011000, 0b00000000, 0b00000000, 0b00000000, 0b00000000],
        'g': [0b00000000, 0b00000000, 0b00111110, 0b01100110, 0b01100110,
            0b00111110, 0b00000110, 0b00111100, 0b00000000, 0b00000000, 0b00000000],
        'h': [0b01100000, 0b01100000, 0b01111100, 0b01100110, 0b01100110,
            0b01100110, 0b01100110, 0b00000000, 0b00000000, 0b00000000, 0b00000000],
        'i': [0b00011000, 0b00000000, 0b00111000, 0b00011000, 0b00011000,
            0b00011000, 0b01111110, 0b00000000, 0b00000000, 0b00000000, 0b00000000],
        'j': [0b00000110, 0b00000000, 0b00000110, 0b00000110, 0b00000110,
            0b00000110, 0b01100110, 0b00111100, 0b00000000, 0b00000000, 0b00000000],
        'k': [0b01100000, 0b01100000, 0b01100110, 0b01101100, 0b01111000,
            0b01101100, 0b01100110, 0b00000000, 0b00000000, 0b00000000, 0b00000000],
        'l': [0b00111000, 0b00011000, 0b00011000, 0b00011000, 0b00011000,
            0b00011000, 0b01111110, 0b00000000, 0b00000000, 0b00000000, 0b00000000],
        'm': [0b00000000, 0b00000000, 0b01101100, 0b11111110, 0b11010110,
            0b11000110, 0b11000110, 0b00000000, 0b00000000, 0b00000000, 0b00000000],
        'n': [0b00000000, 0b00000000, 0b01111100, 0b01100110, 0b01100110,
            0b01100110, 0b01100110, 0b00000000, 0b00000000, 0b00000000, 0b00000000],
        'o': [0b00000000, 0b00000000, 0b00111100, 0b01100110, 0b01100110,
            0b01100110, 0b00111100, 0b00000000, 0b00000000, 0b00000000, 0b00000000],
        'p': [0b00000000, 0b00000000, 0b01111100, 0b01100110, 0b01100110,
            0b01111100, 0b01100000, 0b01100000, 0b00000000, 0b00000000, 0b00000000],
        'q': [0b00000000, 0b00000000, 0b00111110, 0b01100110, 0b01100110,
            0b00111110, 0b00000110, 0b00000110, 0b00000000, 0b00000000, 0b00000000],
        'r': [0b00000000, 0b00000000, 0b01111100, 0b01100110, 0b01100000,
            0b01100000, 0b01100000, 0b00000000, 0b00000000, 0b00000000, 0b00000000],
        's': [0b00000000, 0b00000000, 0b00111110, 0b01100000, 0b00111100,
            0b00000110, 0b01111100, 0b00000000, 0b00000000, 0b00000000, 0b00000000],
        't': [0b00011000, 0b00011000, 0b01111110, 0b00011000, 0b00011000,
            0b00011000, 0b00001110, 0b00000000, 0b00000000, 0b00000000, 0b00000000],
        'u': [0b00000000, 0b00000000, 0b01100110, 0b01100110, 0b01100110,
            0b01100110, 0b00111110, 0b00000000, 0b00000000, 0b00000000, 0b00000000],
        'v': [0b00000000, 0b00000000, 0b01100110, 0b01100110, 0b01100110,
            0b00111100, 0b00011000, 0b00000000, 0b00000000, 0b00000000, 0b00000000],
        'w': [0b00000000, 0b00000000, 0b11000110, 0b11000110, 0b11010110,
            0b11111110, 0b01101100, 0b00000000, 0b00000000, 0b00000000, 0b00000000],
        'x': [0b00000000, 0b00000000, 0b01100110, 0b00111100, 0b00011000,
            0b00111100, 0b01100110, 0b00000000, 0b00000000, 0b00000000, 0b00000000],
        'y': [0b00000000, 0b00000000, 0b01100110, 0b01100110, 0b01100110,
            0b00111110, 0b00000110, 0b00111100, 0b00000000, 0b00000000, 0b00000000],
        'z': [0b00000000, 0b00000000, 0b01111110, 0b00001100, 0b00011000,
            0b00110000, 0b01111110, 0b00000000, 0b00000000, 0b00000000, 0b00000000],
        '{': [0b00001110, 0b00011000, 0b00011000, 0b01110000, 0b00011000,
            0b00011000, 0b00001110, 0b00000000, 0b00000000, 0b00000000, 0b00000000],
        '|': [0b00011000, 0b00011000, 0b00011000, 0b00011000, 0b00011000,
            0b00011000, 0b00011000, 0b00000000, 0b00000000, 0b00000000, 0b00000000],
        '}': [0b01110000, 0b00011000, 0b00011000, 0b00001110, 0b00011000,
            0b00011000, 0b01110000, 0b00000000, 0b00000000, 0b00000000, 0b00000000],
        '~': [0b01110110, 0b11011100, 0b00000000, 0b00000000, 0b00000000,
            0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000],
        }

    def char_to_matrix(self, char):
        """
        Convert a single character to an 8-bit wide by 11-byte high dot matrix.
        
        Args:
            char: A single character to convert
            
        Returns:
            A list of 11 integers, each representing a row (8 bits wide)
        """
        if self.use_gfx_font:
            return self.gfx_font.get_char_bitmap(char, target_height=11)
        else:
            return self.FONT.get(char.upper(), [0b00000000] * 11)

    def allowed_characters(self):
        """
        Return a string of all characters that can be mapped.
        """
        if self.use_gfx_font:
            # Generate characters from first_char to last_char
            chars = []
            for i in range(self.gfx_font.first_char, self.gfx_font.last_char + 1):
                chars.append(chr(i))
            return ''.join(chars)
        else:
            return ''.join(self.FONT.keys())
    
    def char_is_allowed(self, char):
        """
        Check if a character is in the allowed set.
        
        Args:
            char: A single character to check
        Returns:
            True if the character is allowed, False otherwise
        """
        if self.use_gfx_font:
            char_code = ord(char)
            return (char_code >= self.gfx_font.first_char and 
                    char_code <= self.gfx_font.last_char)
        else:
            return char in self.FONT

    def string_to_matrices(self, string):
        """
        Convert a string to a list of dot matrices.
        
        Args:
            string: The string to convert
            
        Returns:
            A list of lists, where each inner list is the dot matrix for a character
        """
        matrices = []
        for char in string:
            matrices.append(self.char_to_matrix(char))
        return matrices
    
    def is_string_allowed(self, string):
        """
        Check if all characters in a string are allowed.
        
        Args:
            string: The string to check
        Returns:
            True if all characters are allowed, False otherwise
        """
        for char in string:
            if not self.char_is_allowed(char):
                return False
        return True
        